- hosts: app
  become: yes
  vars:
    github_repo: "https://github.com/YOUR_USERNAME/bnoverseas.git"
    app_dir: /var/www/nextjs
    
  tasks:
    - name: Update system packages
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - git
          - curl
          - build-essential
          - nginx
          - postgresql-client
        state: present

    - name: Install Node.js 18.x
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        apt-get install -y nodejs
      args:
        creates: /usr/bin/node

    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes

    - name: Clone Next.js repository
      git:
        repo: "{{ github_repo }}"
        dest: "{{ app_dir }}"
        version: main
        force: yes

    - name: Install Node dependencies
      npm:
        path: "{{ app_dir }}"
        production: no

    - name: Create .env file for production
      copy:
        dest: "{{ app_dir }}/.env.local"
        content: |
          # Database
          DATABASE_URL="{{ database_url }}"

          # Authentication
          JWT_SECRET="{{ jwt_secret }}"
          JWT_REFRESH_SECRET="{{ jwt_refresh_secret }}"
          NEXTAUTH_SECRET="{{ nextauth_secret }}"
          NEXTAUTH_URL="http://{{ ansible_host }}"

          # Email Configuration
          SMTP_HOST="{{ smtp_host }}"
          SMTP_PORT="{{ smtp_port }}"
          SMTP_USER="{{ smtp_user }}"
          SMTP_PASS="{{ smtp_pass }}"
          FROM_EMAIL="{{ from_email }}"

          # AWS Configuration
          AWS_ACCESS_KEY_ID="{{ aws_access_key_id }}"
          AWS_SECRET_ACCESS_KEY="{{ aws_secret_access_key }}"
          AWS_REGION="{{ aws_region }}"
          AWS_S3_BUCKET="{{ aws_s3_bucket }}"

          # Payment Gateways
          STRIPE_SECRET_KEY="{{ stripe_secret_key }}"
          STRIPE_PUBLISHABLE_KEY="{{ stripe_publishable_key }}"
          RAZORPAY_KEY_ID="{{ razorpay_key_id }}"
          RAZORPAY_KEY_SECRET="{{ razorpay_key_secret }}"

          # External APIs
          ZOOM_API_KEY="{{ zoom_api_key }}"
          ZOOM_API_SECRET="{{ zoom_api_secret }}"
          TWILIO_ACCOUNT_SID="{{ twilio_account_sid }}"
          TWILIO_AUTH_TOKEN="{{ twilio_auth_token }}"

          # App Configuration
          NEXT_PUBLIC_APP_URL="http://{{ ansible_host }}"
          NEXT_PUBLIC_APP_NAME="BnOverseas"
          NODE_ENV="production"
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    - name: Build Next.js application
      shell: |
        cd {{ app_dir }}
        npm run build
      environment:
        NODE_ENV: production

    - name: Start Next.js with PM2
      shell: |
        cd {{ app_dir }}
        pm2 start npm --name "nextjs-app" -- start
        pm2 startup
        pm2 save
      environment:
        NODE_ENV: production
      become_user: ubuntu

    - name: Configure Nginx reverse proxy
      copy:
        dest: /etc/nginx/sites-available/nextjs
        content: |
          server {
            listen 80;
            server_name _;

            location / {
              proxy_pass http://127.0.0.1:3000;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
            }
          }

    - name: Enable Nginx site
      file:
        src: /etc/nginx/sites-available/nextjs
        dest: /etc/nginx/sites-enabled/nextjs
        state: link
      notify: restart nginx

    - name: Disable default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx

    - name: Test Nginx configuration
      shell: nginx -t
      register: nginx_test
      failed_when: nginx_test.rc != 0

    - name: Install NRPE for Nagios monitoring
      apt:
        name:
          - nagios-nrpe-server
          - nagios-plugins-basic
        state: present

    - name: Configure NRPE
      lineinfile:
        path: /etc/nagios/nrpe.cfg
        regexp: '^allowed_hosts='
        line: "allowed_hosts=127.0.0.1,{{ hostvars['NAGIOS_PUBLIC_IP']['private_ip'] | default('10.0.1.0/24') }}"
      notify: restart nrpe

  handlers:
    - name: restart nginx
      service:
        name: nginx
        state: restarted

    - name: restart nrpe
      service:
        name: nagios-nrpe-server
        state: restarted
        enabled: yes
